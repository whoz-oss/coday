<h2 mat-dialog-title>{{ isEditMode ? 'Edit Scheduler' : 'Create Scheduler' }}</h2>

<mat-dialog-content>
  <div class="form-container">
    <!-- Name -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Name</mat-label>
      <input matInput [(ngModel)]="name" placeholder="My Scheduler" required />
      <mat-hint>A descriptive name for this scheduler</mat-hint>
    </mat-form-field>

    <!-- Prompt Selection -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Prompt</mat-label>
      <mat-select [(ngModel)]="promptId" required>
        @for (prompt of availablePrompts; track prompt.id) {
          <mat-option [value]="prompt.id">
            {{ prompt.name }}
          </mat-option>
        }
      </mat-select>
      <mat-hint>Select the prompt to execute</mat-hint>
    </mat-form-field>

    <!-- Start Date & Time -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Start Date & Time</mat-label>
      <input matInput type="datetime-local" [(ngModel)]="startTimestamp" />
      <mat-hint>When to start the scheduler (leave empty for now)</mat-hint>
    </mat-form-field>

    <!-- Interval -->
    <div class="interval-section">
      <h3>Schedule Interval</h3>
      <div class="interval-fields">
        <mat-form-field appearance="outline" class="interval-value">
          <mat-label>Every</mat-label>
          <input matInput type="number" [(ngModel)]="intervalValue" min="1" required />
        </mat-form-field>
        <mat-form-field appearance="outline" class="interval-unit">
          <mat-label>Unit</mat-label>
          <mat-select [(ngModel)]="intervalUnit" required>
            <mat-option value="min">Minutes (1-59)</mat-option>
            <mat-option value="h">Hours (1-24)</mat-option>
            <mat-option value="d">Days (1-31)</mat-option>
            <mat-option value="M">Months (1-12)</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Days of Week (optional) -->
    <div class="days-section">
      <h3>Days of Week (Optional)</h3>
      <div class="days-checkboxes">
        @for (day of daysOfWeekOptions; track day.value) {
          <mat-checkbox [checked]="isDaySelected(day.value)" (change)="toggleDayOfWeek(day.value)">
            {{ day.label }}
          </mat-checkbox>
        }
      </div>
      <p class="hint">Leave empty to run every day</p>
    </div>

    <!-- End Condition -->
    <div class="end-condition-section">
      <h3>End Condition (Optional)</h3>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>End Type</mat-label>
        <mat-select [(ngModel)]="endConditionType">
          <mat-option value="none">Never (run indefinitely)</mat-option>
          <mat-option value="occurrences">After X occurrences</mat-option>
          <mat-option value="endTimestamp">Until specific date</mat-option>
        </mat-select>
      </mat-form-field>

      @if (endConditionType === 'occurrences') {
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Number of Occurrences</mat-label>
          <input matInput type="number" [(ngModel)]="endOccurrences" min="1" required />
        </mat-form-field>
      }

      @if (endConditionType === 'endTimestamp') {
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>End Date</mat-label>
          <input matInput type="datetime-local" [(ngModel)]="endTimestamp" required />
        </mat-form-field>
      }
    </div>

    <!-- Parameters -->
    <div class="parameters-section">
      <div class="section-header">
        <h3>Parameters (Optional)</h3>
        <mat-button-toggle-group [(ngModel)]="parameterMode" class="mode-toggle">
          <mat-button-toggle value="simple">Simple</mat-button-toggle>
          <mat-button-toggle value="structured">Structured</mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Simple parameter mode -->
      @if (parameterMode === 'simple') {
        <div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Parameter Value</mat-label>
            <input matInput [(ngModel)]="simpleParameter" placeholder="e.g., 1234 or staging" />
            <mat-hint>Simple value for {{ '{{PARAMETERS}}' }} placeholder or appended to first command</mat-hint>
          </mat-form-field>
        </div>
      }

      <!-- Structured parameters mode -->
      @if (parameterMode === 'structured') {
        <div>
          <div class="section-header">
            <button mat-icon-button (click)="addParameter()" type="button" title="Add parameter">
              <mat-icon>add</mat-icon>
            </button>
          </div>

          @if (parameters.length > 0) {
            <div class="parameters-list">
              @for (param of parameters; track $index; let i = $index) {
                <div class="parameter-item">
                  <mat-form-field appearance="outline" class="param-key">
                    <mat-label>Key</mat-label>
                    <input matInput [(ngModel)]="param.key" placeholder="parameterName" />
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="param-value">
                    <mat-label>Value</mat-label>
                    <input matInput [(ngModel)]="param.value" placeholder="value" />
                  </mat-form-field>
                  <button
                    mat-icon-button
                    (click)="removeParameter(i)"
                    type="button"
                    title="Remove parameter"
                    class="remove-btn"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              }
            </div>
          }
          <p class="hint">Key-value pairs for {{ '{{key}}' }} placeholders in prompt commands</p>
        </div>
      }
    </div>

    <!-- Enabled -->
    <div class="enabled-section">
      <mat-checkbox [(ngModel)]="enabled">Enabled</mat-checkbox>
      <p class="hint">Scheduler will only run if enabled</p>
    </div>

    <!-- Error message -->
    @if (errorMessage) {
      <div class="error-message">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>
    }
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="isSaving">Cancel</button>
  <button mat-raised-button color="primary" (click)="save()" [disabled]="isSaving">
    {{ isSaving ? 'Saving...' : 'Save' }}
  </button>
</mat-dialog-actions>
