<!-- Floating Action Button to toggle sidenav -->
<button
  class="sidenav-toggle-btn"
  (click)="toggle()"
  [class.active]="isOpen"
  [class.hidden]="isOpen"
  title="Menu Coday"
  type="button"
>
  <img src="CODAY-Logo.png" alt="Coday" class="logo" />
  <div class="hamburger-overlay">
    <mat-icon>menu</mat-icon>
  </div>
</button>

<!-- Material Sidenav Container -->
<mat-sidenav-container class="sidenav-container" [hasBackdrop]="false">
  <mat-sidenav mode="push" position="start" [opened]="isOpen" (closed)="close()" class="app-sidenav">
    <!-- Sidenav Header with Project Selector -->
    <div class="sidenav-header">
      <img src="CODAY-Logo.png" alt="Coday" class="sidenav-logo" />
      <div class="header-title-section">
        @if (canShowProjectSelector()) {
          <!-- Native select when projects are available -->
          <div class="select-wrapper">
            <select
              class="project-select"
              [(ngModel)]="selectedProjectName"
              (change)="onProjectChange($event)"
              [title]="'Select project'"
            >
              @for (project of getProjectList(); track project.name) {
                <option [value]="project.name">{{ project.name }}</option>
              }
            </select>
            <mat-icon class="select-arrow">expand_more</mat-icon>
          </div>
        } @else {
          <!-- Static title when no projects available -->
          <h2 class="sidenav-title">{{ getProjectDisplayName() }}</h2>
        }
      </div>
      <button mat-icon-button (click)="close()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Expansion Panels Container -->
    <mat-accordion multi class="sidenav-accordion">
      <!-- Threads Panel - Expanded by default -->
      <mat-expansion-panel [expanded]="true" class="sidenav-panel">
        <mat-expansion-panel-header>
          <mat-panel-title class="panel-title">
            <mat-icon class="panel-icon">forum</mat-icon>
            <span>Threads</span>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="panel-content">
          <app-thread-selector class="sidenav-thread-selector"></app-thread-selector>
        </div>
      </mat-expansion-panel>

      <!-- Preferences Panel -->
      <mat-expansion-panel class="sidenav-panel">
        <mat-expansion-panel-header>
          <mat-panel-title class="panel-title">
            <mat-icon class="panel-icon">settings</mat-icon>
            <span>Configuration</span>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="panel-content">
          <div class="preference-item">
            <div class="preference-content">
              <!-- User Config -->
              <button class="sidenav-item" (click)="openUserConfig(); $event.stopPropagation()" mat-button>
                <mat-icon class="item-icon">person</mat-icon>
                <span class="item-text">User Config</span>
              </button>
            </div>

            <!-- Project Config - Admin only -->
            @if (isAdmin) {
              <button
                class="sidenav-item"
                (click)="openProjectConfig(); $event.stopPropagation()"
                [disabled]="!hasProject()"
                mat-button
              >
                <mat-icon class="item-icon">folder</mat-icon>
                <span class="item-text">Project Config</span>
                @if (!hasProject()) {
                  <span class="disabled-hint">(No project)</span>
                }
              </button>

              <!-- Webhooks - Admin only -->
              <button class="sidenav-item" (click)="openWebhooks(); $event.stopPropagation()" mat-button>
                <mat-icon class="item-icon">webhook</mat-icon>
                <span class="item-text">Webhooks</span>
              </button>
            }
          </div>
        </div>

        <div class="panel-content">
          <!-- Theme Selector -->
          <div class="preference-item">
            <div class="preference-header">
              <mat-icon class="item-icon">palette</mat-icon>
              <span class="item-text">Theme</span>
            </div>
            <div class="preference-content">
              <app-theme-selector></app-theme-selector>
            </div>
          </div>

          <!-- Options -->
          <div class="preference-item">
            <app-options-panel class="inline-panel"></app-options-panel>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </mat-sidenav>

  <mat-sidenav-content>
    <!-- Content goes here (router-outlet) -->
    <ng-content></ng-content>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Error notification -->
@if (configErrorMessage) {
  <div class="error-notification" role="alert">
    <mat-icon class="error-icon">warning</mat-icon>
    <span class="error-text">{{ configErrorMessage }}</span>
    <button class="error-close" (click)="configErrorMessage = ''" aria-label="Close error message" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- JSON Editor Modals -->
<app-json-editor
  [configType]="'user'"
  [isOpen]="isUserConfigOpen"
  [initialContent]="userConfigJson"
  [isLoading]="isLoadingUserConfig"
  [isSaving]="isSavingUserConfig"
  (save)="onUserConfigSave($event)"
  (closeEditor)="onUserConfigCancel()"
></app-json-editor>

@if (hasProject()) {
  <app-json-editor
    [configType]="'project'"
    [projectName]="getCurrentProjectName()!"
    [isOpen]="isProjectConfigOpen"
    [initialContent]="projectConfigJson"
    [isLoading]="isLoadingProjectConfig"
    [isSaving]="isSavingProjectConfig"
    (save)="onProjectConfigSave($event)"
    (closeEditor)="onProjectConfigCancel()"
  ></app-json-editor>
}

<!-- Webhook Manager Modal -->
<app-webhook-manager
  [isOpen]="isWebhooksOpen"
  [availableProjects]="getAvailableProjects()"
  (isOpenChange)="isWebhooksOpen = $event"
  (closeModal)="isWebhooksOpen = false"
></app-webhook-manager>
