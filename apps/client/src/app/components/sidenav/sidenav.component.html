<!-- Floating Action Button to toggle sidenav -->
<button
  class="sidenav-toggle-btn"
  (click)="toggle()"
  [class.active]="isOpen"
  [class.hidden]="isOpen"
  title="Menu Coday"
  type="button"
>
  <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="logo" />
  <div class="hamburger-overlay">
    <mat-icon>menu</mat-icon>
  </div>
</button>

<!-- Material Sidenav Container -->
<mat-sidenav-container class="sidenav-container" [hasBackdrop]="false">
  <mat-sidenav mode="push" position="start" [opened]="isOpen" (closed)="close()" class="app-sidenav">
    <!-- Sidenav Header with Project Selector -->
    <div class="sidenav-header">
      <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="sidenav-logo" />
      <div class="header-title-section">
        @if (canShowProjectSelector()) {
          <!-- Native select when projects are available -->
          <div class="select-wrapper">
            <select
              class="project-select"
              [(ngModel)]="selectedProjectName"
              (change)="onProjectChange($event)"
              [title]="'Select project'"
            >
              @for (project of getProjectList(); track project.name) {
                <option [value]="project.name">{{ project.name }}</option>
              }
            </select>
            <mat-icon class="select-arrow">expand_more</mat-icon>
          </div>
        } @else {
          <!-- Static title when no projects available -->
          <h2 class="sidenav-title">{{ getProjectDisplayName() }}</h2>
        }
      </div>
      <button mat-icon-button (click)="close()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- New Thread Link - Always Visible -->
    <div class="new-thread-section">
      <a class="new-thread-link" (click)="createNewThread()" role="button" tabindex="0">
        <mat-icon fontSet="material-icons-outlined">play_circle</mat-icon>
        <span class="new-thread-text">Start a new thread</span>
      </a>
    </div>

    <!-- Expansion Panels Container -->
    <div class="sidenav-sections">
      <!-- Threads Section - Expanded by default -->
      <div class="section-container">
        <button
          class="section-toggle"
          [class.active]="expandedSections['threads']"
          (click)="toggleSection('threads')"
          type="button"
        >
          @if (expandedSections['threads']) {
            <mat-icon class="arrow-icon expanded">keyboard_arrow_up</mat-icon>
          } @else {
            <mat-icon class="section-icon">forum</mat-icon>
          }
          <span class="section-label">Threads</span>
        </button>
        @if (expandedSections['threads']) {
          <div class="section-content">
            <app-thread-selector class="sidenav-thread-selector"></app-thread-selector>
          </div>
        }
      </div>

      <!-- Configuration Section -->
      <div class="section-container">
        <button
          class="section-toggle"
          [class.active]="expandedSections['config']"
          (click)="toggleSection('config')"
          type="button"
        >
          @if (expandedSections['config']) {
            <mat-icon class="arrow-icon expanded">keyboard_arrow_up</mat-icon>
          } @else {
            <mat-icon class="section-icon">tune</mat-icon>
          }
          <span class="section-label">Preferences</span>
        </button>
        @if (expandedSections['config']) {
          <div class="section-content">
            <!-- Options -->
            <div class="preference-item">
              <app-options-panel class="inline-panel"></app-options-panel>
            </div>
          </div>
        }

        <div class="section-container">
          <button class="section-toggle" (click)="openUserConfig(); $event.stopPropagation()" type="button">
            <mat-icon class="section-icon">settings</mat-icon>
            <span class="section-label">User Configuration</span>
          </button>
        </div>

        <!-- Admin only -->
        @if (isAdmin) {
          <!-- Project Config -->
          @if (hasProject()) {
            <div class="section-container">
              <button class="section-toggle" (click)="openProjectConfig(); $event.stopPropagation()" type="button">
                <mat-icon class="section-icon">settings_applications</mat-icon>
                <span class="section-label">Project Configuration</span>
              </button>
            </div>
          } @else {
            <div class="section-container">
              <button
                class="section-toggle"
                (click)="openProjectConfig(); $event.stopPropagation()"
                type="button"
                disabled
              >
                <mat-icon class="section-icon">settings_applications</mat-icon>
                <span class="section-label">Project config (No project)</span>
              </button>
            </div>
          }
          <!-- Webhooks - Admin only -->
          <div class="section-container">
            <button class="section-toggle" (click)="openWebhooks(); $event.stopPropagation()" type="button">
              <mat-icon class="section-icon">webhook</mat-icon>
              <span class="section-label">Webhooks</span>
            </button>
          </div>
        }
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <!-- Content goes here (router-outlet) -->
    <ng-content></ng-content>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Error notification -->
@if (configErrorMessage) {
  <div class="error-notification" role="alert">
    <mat-icon class="error-icon">warning</mat-icon>
    <span class="error-text">{{ configErrorMessage }}</span>
    <button class="error-close" (click)="configErrorMessage = ''" aria-label="Close error message" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- JSON Editor Modals -->
<app-json-editor
  [configType]="'user'"
  [isOpen]="isUserConfigOpen"
  [initialContent]="userConfigJson"
  [isLoading]="isLoadingUserConfig"
  [isSaving]="isSavingUserConfig"
  (save)="onUserConfigSave($event)"
  (closeEditor)="onUserConfigCancel()"
></app-json-editor>

@if (hasProject()) {
  <app-json-editor
    [configType]="'project'"
    [projectName]="getCurrentProjectName()!"
    [isOpen]="isProjectConfigOpen"
    [initialContent]="projectConfigJson"
    [isLoading]="isLoadingProjectConfig"
    [isSaving]="isSavingProjectConfig"
    (save)="onProjectConfigSave($event)"
    (closeEditor)="onProjectConfigCancel()"
  ></app-json-editor>
}

<!-- Webhook Manager Modal -->
<app-webhook-manager
  [isOpen]="isWebhooksOpen"
  [availableProjects]="getAvailableProjects()"
  (isOpenChange)="isWebhooksOpen = $event"
  (closeModal)="isWebhooksOpen = false"
></app-webhook-manager>
