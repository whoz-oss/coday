<!-- Floating Action Button to toggle sidenav -->
@if (!isOpen) {
  <button mat-icon-button class="sidenav-toggle-btn" (click)="toggle()" title="Menu" type="button">
    <mat-icon>menu</mat-icon>
  </button>

  <!-- Floating Logo Button at Bottom -->
  @if (!isOpen) {
    <a
      href="https://github.com/whoz-oss/coday"
      target="_blank"
      rel="noopener noreferrer"
      class="sidenav-logo-btn"
      title="Contribute on GitHub"
    >
      <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="logo" />
    </a>
  }
}

<!-- Material Sidenav Container -->
<mat-sidenav-container class="sidenav-container" [hasBackdrop]="false">
  <mat-sidenav mode="push" position="start" [opened]="isOpen" (closed)="close()" class="app-sidenav">
    <!-- Sidenav Header with Project Selector -->
    <div class="sidenav-header">
      <button mat-icon-button (click)="close()" class="close-btn" title="Close menu">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <img 
        [attr.src]="'CODAY-Logo.png'" 
        alt="coday" 
        [class.sidenav-logo]="true"
        [class.clickable]="!forcedProject()"
        [class.disabled]="forcedProject()"
        (click)="navigateToHome(); $event.stopPropagation()"
        [title]="forcedProject() ? 'Project selection disabled' : 'Go to project selection'"
        [attr.role]="forcedProject() ? null : 'button'"
        [attr.tabindex]="forcedProject() ? null : '0'"
        (keydown.enter)="navigateToHome(); $event.preventDefault(); $event.stopPropagation()"
        (keydown.space)="navigateToHome(); $event.preventDefault(); $event.stopPropagation()"
      />
      <div class="header-title-section">
        <!-- Project name display -->
        <h2 class="sidenav-title">{{ selectedProjectName() }}</h2>
      </div>
    </div>

    <!-- New Thread Link - Always Visible -->
    <div class="new-thread-section">
      <a class="new-thread-link" (click)="createNewThread()" role="button" tabindex="0">
        <mat-icon fontSet="material-icons-outlined">play_circle</mat-icon>
        <span class="new-thread-text">Start a new thread</span>
      </a>
    </div>

      <!-- Expansion Panels Container -->
      <div class="sidenav-sections" [class.has-footer]="true">
        <!-- Threads Section - Expanded by default -->
        <div class="section-container">
          @if (isThreadSearchActive && expandedSections['threads']) {
            <!-- Search mode: show search bar instead of title -->
            <div class="search-header">
              <mat-icon class="search-icon">search</mat-icon>
              <input
                #threadSearchInput
                type="text"
                class="search-input"
                placeholder="Search threads..."
                [(ngModel)]="threadSearchQuery"
                (input)="onThreadSearchInput()"
              />
              <button
                mat-icon-button
                class="close-search-btn"
                (click)="closeThreadSearch()"
                title="Close search"
                type="button"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          } @else {
            <!-- Normal mode: show section toggle -->
            <button
              class="section-toggle"
              [class.active]="expandedSections['threads']"
              (click)="toggleSection('threads')"
              type="button"
            >
              @if (expandedSections['threads']) {
                <mat-icon class="arrow-icon expanded">keyboard_arrow_up</mat-icon>
              } @else {
                <mat-icon class="section-icon">forum</mat-icon>
              }
              <span class="section-label">Threads</span>
              @if (expandedSections['threads']) {
                <button
                  mat-icon-button
                  class="search-button"
                  (click)="toggleThreadSearch($event)"
                  title="Search threads"
                  type="button"
                >
                  <mat-icon>search</mat-icon>
                </button>
              }
            </button>
          }
          @if (expandedSections['threads']) {
            <div class="section-content threads">
              <app-thread-selector
                class="sidenav-thread-selector"
                [searchMode]="isThreadSearchActive"
                [searchQuery]="threadSearchQuery"
                (searchModeChange)="onThreadSearchModeChange($event)"
              ></app-thread-selector>
            </div>
          }
        </div>

        <!-- Configuration Section -->
        <div class="section-container">
          <button
            class="section-toggle"
            [class.active]="expandedSections['config']"
            (click)="toggleSection('config')"
            type="button"
          >
            @if (expandedSections['config']) {
              <mat-icon class="arrow-icon expanded">keyboard_arrow_up</mat-icon>
            } @else {
              <mat-icon class="section-icon">tune</mat-icon>
            }
            <span class="section-label">Preferences</span>
          </button>
          @if (expandedSections['config']) {
            <div class="section-content">
              <!-- Options -->
              <div class="preference-item">
                <app-options-panel class="inline-panel"></app-options-panel>
              </div>
            </div>
          }

          <div class="section-container">
            <button class="section-toggle" (click)="openUserConfig(); $event.stopPropagation()" type="button">
              <mat-icon class="section-icon">settings</mat-icon>
              <span class="section-label">User Configuration</span>
            </button>
          </div>

          <div class="section-container">
            <a
              href="https://github.com/whoz-oss/coday"
              target="_blank"
              rel="noopener noreferrer"
              class="section-toggle contribute-btn"
              title="Contribute on GitHub"
            >
              <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="contribute-logo" />
              <span class="section-label">Contribute on GitHub</span>
            </a>
          </div>

          <!-- Admin only -->
          @if (isAdmin) {
            <!-- Project Config -->
            @if (selectedProjectName()) {
              <div class="section-container">
                <button class="section-toggle" (click)="openProjectConfig(); $event.stopPropagation()" type="button">
                  <mat-icon class="section-icon">settings_applications</mat-icon>
                  <span class="section-label">Project Configuration</span>
                </button>
              </div>
            } @else {
              <div class="section-container">
                <button
                  class="section-toggle"
                  (click)="openProjectConfig(); $event.stopPropagation()"
                  type="button"
                  disabled
                >
                  <mat-icon class="section-icon">settings_applications</mat-icon>
                  <span class="section-label">Project config (No project)</span>
                </button>
              </div>
            }
            <!-- Webhooks - Admin only -->
            <div class="section-container">
              <button class="section-toggle" (click)="openWebhooks(); $event.stopPropagation()" type="button">
                <mat-icon class="section-icon">webhook</mat-icon>
                <span class="section-label">Webhooks</span>
              </button>
            </div>
          }
        </div>
      </div>

  </mat-sidenav>

  <mat-sidenav-content>
    <!-- Content goes here (router-outlet) -->
    <ng-content></ng-content>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Error notification -->
@if (configErrorMessage) {
  <div class="error-notification" role="alert">
    <mat-icon class="error-icon">warning</mat-icon>
    <span class="error-text">{{ configErrorMessage }}</span>
    <button class="error-close" (click)="configErrorMessage = ''" aria-label="Close error message" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- JSON Editor Modals -->
<app-json-editor
  [configType]="'user'"
  [isOpen]="isUserConfigOpen"
  [initialContent]="userConfigJson"
  [isLoading]="isLoadingUserConfig"
  [isSaving]="isSavingUserConfig"
  (save)="onUserConfigSave($event)"
  (closeEditor)="onUserConfigCancel()"
></app-json-editor>

@if (selectedProjectName()) {
  <app-json-editor
    [configType]="'project'"
    [projectName]="selectedProjectName()!"
    [isOpen]="isProjectConfigOpen"
    [initialContent]="projectConfigJson"
    [isLoading]="isLoadingProjectConfig"
    [isSaving]="isSavingProjectConfig"
    (save)="onProjectConfigSave($event)"
    (closeEditor)="onProjectConfigCancel()"
  ></app-json-editor>
}

<!-- Webhook Manager Modal -->
<app-webhook-manager
  [isOpen]="isWebhooksOpen"
  [availableProjects]="getAvailableProjects()"
  (isOpenChange)="isWebhooksOpen = $event"
  (closeModal)="isWebhooksOpen = false"
></app-webhook-manager>
