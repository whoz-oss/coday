<!-- Floating Action Button to toggle sidenav -->
<button
  class="sidenav-toggle-btn"
  (click)="toggle()"
  [class.active]="isOpen"
  [class.hidden]="isOpen"
  title="Menu Coday"
  type="button"
>
  <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="logo" />
  <div class="hamburger-overlay">
    <mat-icon>menu</mat-icon>
  </div>
</button>

<!-- Material Sidenav Container -->
<mat-sidenav-container class="sidenav-container" [hasBackdrop]="false">
  <mat-sidenav mode="push" position="start" [opened]="isOpen" (closed)="close()" class="app-sidenav">
    <!-- Sidenav Header with Project Selector -->
    <div class="sidenav-header">
      <img [attr.src]="'CODAY-Logo.png'" alt="Coday" class="sidenav-logo" />
      <div class="header-title-section">
        @if (canShowProjectSelector()) {
          <!-- Native select when projects are available -->
          <div class="select-wrapper">
            <select
              class="project-select"
              [(ngModel)]="selectedProjectName"
              (change)="onProjectChange($event)"
              [title]="'Select project'"
            >
              @for (project of getProjectList(); track project.name) {
                <option [value]="project.name">{{ project.name }}</option>
              }
            </select>
            <mat-icon class="select-arrow">expand_more</mat-icon>
          </div>
        } @else {
          <!-- Static title when no projects available -->
          <h2 class="sidenav-title">{{ getProjectDisplayName() }}</h2>
        }
      </div>
      <button mat-icon-button (click)="close()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- New Thread Link - Always Visible -->
    <div class="new-thread-section">
      <a class="new-thread-link" (click)="createNewThread()" role="button" tabindex="0">
        <mat-icon fontSet="material-icons-outlined">edit_note</mat-icon>
        <span class="new-thread-text">Start a new thread</span>
      </a>
    </div>

    <!-- Expansion Panels Container -->
    <div class="sidenav-sections">
      <!-- Threads Section - Expanded by default -->
      <div class="section-container">
        <button class="section-toggle" (click)="toggleSection('threads')" type="button">
          <mat-icon class="arrow-icon" [class.expanded]="expandedSections['threads']">chevron_right</mat-icon>
          <mat-icon class="section-icon">forum</mat-icon>
          <span class="section-label">Threads</span>
        </button>
        @if (expandedSections['threads']) {
          <div class="section-content">
            <app-thread-selector class="sidenav-thread-selector"></app-thread-selector>
          </div>
        }
      </div>

      <!-- Configuration Section -->
      <div class="section-container">
        <button class="section-toggle" (click)="toggleSection('config')" type="button">
          <mat-icon class="arrow-icon" [class.expanded]="expandedSections['config']">chevron_right</mat-icon>
          <mat-icon class="section-icon">settings</mat-icon>
          <span class="section-label">Configuration</span>
        </button>
        @if (expandedSections['config']) {
          <div class="section-content">
            <div class="config-links">
              <!-- User Config -->
              <a class="sidenav-link" (click)="openUserConfig(); $event.stopPropagation()" role="button" tabindex="0">
                <mat-icon fontSet="material-icons-outlined">edit_square</mat-icon>
                <span class="item-text">Edit user config</span>
              </a>

              <!-- Project Config - Admin only -->
              @if (isAdmin) {
                @if (hasProject()) {
                  <a
                    class="sidenav-link"
                    (click)="openProjectConfig(); $event.stopPropagation()"
                    role="button"
                    tabindex="0"
                  >
                    <mat-icon fontSet="material-icons-outlined">folder</mat-icon>
                    <span class="item-text">Project config</span>
                  </a>
                } @else {
                  <span class="sidenav-link disabled">
                    <mat-icon fontSet="material-icons-outlined">folder</mat-icon>
                    <span class="item-text">Project config (No project)</span>
                  </span>
                }

                <!-- Webhooks - Admin only -->
                <a class="sidenav-link" (click)="openWebhooks(); $event.stopPropagation()" role="button" tabindex="0">
                  <mat-icon fontSet="material-icons-outlined">webhook</mat-icon>
                  <span class="item-text">Webhooks</span>
                </a>
              }
            </div>

            <!-- Theme Selector -->
            <div class="preference-item">
              <div class="preference-header">
                <mat-icon class="item-icon">palette</mat-icon>
                <span class="item-text">Theme</span>
              </div>
              <div class="preference-content">
                <app-theme-selector></app-theme-selector>
              </div>
            </div>

            <!-- Options -->
            <div class="preference-item">
              <app-options-panel class="inline-panel"></app-options-panel>
            </div>
          </div>
        }
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <!-- Content goes here (router-outlet) -->
    <ng-content></ng-content>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Error notification -->
@if (configErrorMessage) {
  <div class="error-notification" role="alert">
    <mat-icon class="error-icon">warning</mat-icon>
    <span class="error-text">{{ configErrorMessage }}</span>
    <button class="error-close" (click)="configErrorMessage = ''" aria-label="Close error message" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
}

<!-- JSON Editor Modals -->
<app-json-editor
  [configType]="'user'"
  [isOpen]="isUserConfigOpen"
  [initialContent]="userConfigJson"
  [isLoading]="isLoadingUserConfig"
  [isSaving]="isSavingUserConfig"
  (save)="onUserConfigSave($event)"
  (closeEditor)="onUserConfigCancel()"
></app-json-editor>

@if (hasProject()) {
  <app-json-editor
    [configType]="'project'"
    [projectName]="getCurrentProjectName()!"
    [isOpen]="isProjectConfigOpen"
    [initialContent]="projectConfigJson"
    [isLoading]="isLoadingProjectConfig"
    [isSaving]="isSavingProjectConfig"
    (save)="onProjectConfigSave($event)"
    (closeEditor)="onProjectConfigCancel()"
  ></app-json-editor>
}

<!-- Webhook Manager Modal -->
<app-webhook-manager
  [isOpen]="isWebhooksOpen"
  [availableProjects]="getAvailableProjects()"
  (isOpenChange)="isWebhooksOpen = $event"
  (closeModal)="isWebhooksOpen = false"
></app-webhook-manager>
