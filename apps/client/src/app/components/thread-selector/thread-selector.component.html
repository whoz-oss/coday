<div
  class="thread-selector"
  (click)="$event.stopPropagation()"
  (keydown)="$event.stopPropagation()"
  tabindex="0"
  role="application"
  aria-label="Thread selector"
>
  <!-- Thread list (always visible in sidenav) -->
  @if (currentProject()?.name) {
    <div class="thread-list" role="menu" aria-label="Thread selection">
      <!-- Loading state -->
      @if (isLoadingThreadList()) {
        <div class="thread-loading">
          <span class="loading-spinner"></span>
          <span class="loading-text">Loading threads...</span>
        </div>
      } @else {
        <!-- Grouped threads -->
        @for (group of getGroupedThreads(); track group.label) {
          <div class="thread-group">
            <div class="thread-group-header">{{ group.label }}</div>
            @for (thread of group.threads; track thread.id) {
              <div class="thread-item-wrapper" [class.current]="thread.id === currentThread()?.id">
                <!-- Thread name (clickable) -->
                <a
                  class="thread-item"
                  [title]="thread.name || 'Generating name...'"
                  (click)="selectThread(thread.id); $event.preventDefault()"
                  role="menuitem"
                  tabindex="0"
                >
                  @if (thread.name) {
                    <span class="thread-name">{{ thread.name }}</span>
                  } @else {
                    <mat-spinner class="thread-name-spinner" [diameter]="16"></mat-spinner>
                    <span class="thread-name thread-name-generating">Generating name...</span>
                  }
                </a>

                <!-- Action buttons (right, absolutely positioned) -->
                <div class="action-buttons">
                  <button
                    mat-icon-button
                    class="action-button star-button"
                    [class.starred]="isStarred(thread)"
                    [title]="isStarred(thread) ? 'Unstar thread' : 'Star thread'"
                    (click)="toggleStar($event, thread)"
                    type="button"
                  >
                    <mat-icon>{{ isStarred(thread) ? 'star' : 'star_outline' }}</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    class="action-button delete-button"
                    title="Delete thread"
                    (click)="deleteThread($event, thread)"
                    type="button"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        }

        <!-- Empty states -->
        @if (!threads()?.length && !searchQuery) {
          <div class="thread-empty">No existing threads</div>
        } @else if (searchQuery && getGroupedThreads().length === 0) {
          <div class="thread-empty">No threads matching "{{ searchQuery }}"</div>
        }
      }
    </div>
  } @else {
    <div class="thread-disabled">
      @if (!currentProject()?.name) {
        <span class="disabled-text">No project selected</span>
      } @else {
        <span class="disabled-text">Loading...</span>
      }
    </div>
  }
</div>
