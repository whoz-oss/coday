<div class="chat-input-container">
  @if (isRecording) {
    <div class="recording-indicator">
      <span class="recording-dot"></span>
      Recording... Release to stop
    </div>
  }

  <!-- Autocomplete popup - appears above textarea -->
  @if (autocompleteVisible) {
    <div class="autocomplete-popup">
      <div class="autocomplete-header">
        {{ autocompleteTrigger === '@' ? 'Agents' : 'Commands' }} matching "{{ getAutocompleteQuery() }}"
      </div>
      @for (item of autocompleteItems; track item.name; let i = $index) {
        <div
          class="autocomplete-item"
          [class.selected]="i === selectedAutocompleteIndex"
          (click)="selectAutocompleteItemByClick(i)"
          (mouseenter)="selectedAutocompleteIndex = i"
        >
          <div class="item-name">{{ autocompleteTrigger }}{{ item.name }}</div>
          <div class="item-description">{{ item.description }}</div>
        </div>
      }
    </div>
  }

  <!-- Input row: textarea + voice + send, all inside rounded box -->
  <div
    class="input-row grouped-input"
    [class.focused]="isFocused"
    [class.welcome-mode]="showWelcome"
    [class.is-thinking]="isThinking"
  >
    <textarea
      #messageInput
      class="message-input"
      [(ngModel)]="message"
      [placeholder]="getPlaceholder()"
      (keydown)="onKeyDown($event)"
      (input)="onInput()"
      [disabled]="isDisabled || isThinking || isLocallyDisabled"
      (focus)="isFocused = true"
      (blur)="isFocused = false"
    ></textarea>
    @if (!isSessionInitializing) {
      @if (isThinking) {
        <button class="stop-btn" mat-icon-button (click)="onStopClick()" title="Stop generation" type="button">
          <mat-icon>stop</mat-icon>
        </button>
      } @else {
        <button
          class="send-btn"
          mat-icon-button
          (click)="sendMessage()"
          [disabled]="isDisabled || !message.trim() || isLocallyDisabled"
          [class.hidden]="isDisabled || !message.trim() || isLocallyDisabled"
          [class.active]="!!message.trim() && !isDisabled && !isLocallyDisabled"
          [title]="getSendButtonTooltip()"
          type="button"
        >
          <mat-icon>send</mat-icon>
        </button>
        <button
          class="voice-btn"
          mat-icon-button
          [class.recording]="isRecording"
          [class.hidden]="message.trim()"
          (mousedown)="onVoiceButtonMouseDown($event)"
          (mouseup)="onVoiceButtonMouseUp()"
          (mouseleave)="onVoiceButtonMouseLeave()"
          (touchstart)="onVoiceButtonTouchStart($event)"
          (touchend)="onVoiceButtonTouchEnd($event)"
          (keydown)="onVoiceButtonKeyDown($event)"
          (keyup)="onVoiceButtonKeyUp($event)"
          tabindex="0"
          title="Hold mouse click, touch, or spacebar to speak"
        >
          <mat-icon>{{ isRecording ? 'fiber_manual_record' : 'mic' }}</mat-icon>
        </button>
      }
    }
  </div>
</div>
